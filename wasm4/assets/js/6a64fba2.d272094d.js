(self.webpackChunksite=self.webpackChunksite||[]).push([[4810],{3905:function(x,n,e){"use strict";e.d(n,{Zo:function(){return l},kt:function(){return f}});var t=e(7294);function o(x,n,e){return n in x?Object.defineProperty(x,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):x[n]=e,x}function r(x,n){var e=Object.keys(x);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(x);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(x,n).enumerable}))),e.push.apply(e,t)}return e}function i(x){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?r(Object(e),!0).forEach((function(n){o(x,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(x,Object.getOwnPropertyDescriptors(e)):r(Object(e)).forEach((function(n){Object.defineProperty(x,n,Object.getOwnPropertyDescriptor(e,n))}))}return x}function a(x,n){if(null==x)return{};var e,t,o=function(x,n){if(null==x)return{};var e,t,o={},r=Object.keys(x);for(t=0;t<r.length;t++)e=r[t],n.indexOf(e)>=0||(o[e]=x[e]);return o}(x,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(x);for(t=0;t<r.length;t++)e=r[t],n.indexOf(e)>=0||Object.prototype.propertyIsEnumerable.call(x,e)&&(o[e]=x[e])}return o}var u=t.createContext({}),s=function(x){var n=t.useContext(u),e=n;return x&&(e="function"==typeof x?x(n):i(i({},n),x)),e},l=function(x){var n=s(x.components);return t.createElement(u.Provider,{value:n},x.children)},c={inlineCode:"code",wrapper:function(x){var n=x.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(x,n){var e=x.components,o=x.mdxType,r=x.originalType,u=x.parentName,l=a(x,["components","mdxType","originalType","parentName"]),d=s(e),f=o,p=d["".concat(u,".").concat(f)]||d[f]||c[f]||r;return e?t.createElement(p,i(i({ref:n},l),{},{components:e})):t.createElement(p,i({ref:n},l))}));function f(x,n){var e=arguments,o=n&&n.mdxType;if("string"==typeof x||o){var r=e.length,i=new Array(r);i[0]=d;var a={};for(var u in n)hasOwnProperty.call(n,u)&&(a[u]=n[u]);a.originalType=x,a.mdxType="string"==typeof x?x:o,i[1]=a;for(var s=2;s<r;s++)i[s]=e[s];return t.createElement.apply(null,i)}return t.createElement.apply(null,e)}d.displayName="MDXCreateElement"},7545:function(x,n,e){"use strict";e.r(n),e.d(n,{frontMatter:function(){return a},contentTitle:function(){return u},metadata:function(){return s},toc:function(){return l},default:function(){return d}});var t=e(2122),o=e(9756),r=(e(7294),e(3905)),i=["components"],a={},u="Finishing the sequencer",s={unversionedId:"tutorials/iwas/finishing-the-sequencer",id:"tutorials/iwas/finishing-the-sequencer",isDocsHomePage:!1,title:"Finishing the sequencer",description:"Here's the full code explained above, with a small song file included:",source:"@site/docs/tutorials/iwas/finishing-the-sequencer.md",sourceDirName:"tutorials/iwas",slug:"/tutorials/iwas/finishing-the-sequencer",permalink:"/wasm4/docs/tutorials/iwas/finishing-the-sequencer",editUrl:"https://github.com/aduros/wasm4/edit/main/site/docs/tutorials/iwas/finishing-the-sequencer.md",version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Implementing a driver",permalink:"/wasm4/docs/tutorials/iwas/implementing-the-driver"}},l=[{value:"Optional challenges",id:"optional-challenges",children:[]}],c={toc:l};function d(x){var n=x.components,e=(0,o.Z)(x,i);return(0,r.kt)("wrapper",(0,t.Z)({},c,e,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"finishing-the-sequencer"},"Finishing the sequencer"),(0,r.kt)("p",null,"Here's the full code explained above, with a small song file included:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import * as w4 from \"./wasm4\";\n\n/** Music data. */\nexport const data: usize = memory.data<u8>([\n    0x49, 0x57, 0x41, 0x53, 0x00, 0x01, 0x03, 0x02, 0x00, 0x00, 0x00, 0x01,\n    0x01, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x05, 0x05, 0x00, 0x64, 0x01, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0F, 0x00,\n    0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x01, 0x01, 0x00, 0x2B, 0x2B, 0x2B, 0x00, 0x00, 0x2B, 0x2B, 0x2B,\n    0x00, 0x2B, 0x2B, 0x2E, 0x2E, 0x29, 0x29, 0x00, 0x00, 0x00, 0x30, 0x30,\n    0x30, 0x30, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x00,\n    0x30, 0x30, 0x00, 0x30, 0x30, 0x00, 0x2E, 0x2E, 0x00, 0x2B, 0x2B, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0F, 0x00, 0x64,\n    0x02, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0F, 0x00, 0x64, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFB, 0x00, 0x01, 0x01, 0x00,\n    0x26, 0x26, 0x26, 0x00, 0x00, 0x26, 0x26, 0x26, 0x00, 0x26, 0x26, 0x29,\n    0x29, 0x24, 0x24, 0x00, 0x00, 0x00, 0x2B, 0x2B, 0x2B, 0x2B, 0x00, 0x2B,\n    0x2B, 0x00, 0x2B, 0x2B, 0x00, 0x2B, 0x2B, 0x00, 0x2B, 0x2B, 0x00, 0x2B,\n    0x2B, 0x00, 0x29, 0x29, 0x00, 0x26, 0x26, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x05, 0x0F, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x05, 0x0F, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x21, 0x21, 0x21, 0x21,\n    0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x24, 0x24, 0x24, 0x24, 0x24,\n    0x24, 0x24, 0x24, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F,\n    0x1F, 0x00, 0x00, 0x00, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x21, 0x21, 0x21,\n    0x21, 0x21, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00,\n    0x05, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0F, 0x00,\n    0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x01, 0x01, 0x00, 0x24, 0x00, 0x00, 0x24, 0x00, 0x00, 0x2E, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x24, 0x00, 0x2E, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x24, 0x00, 0x00, 0x2E, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x24, 0x00, 0x00, 0x2E, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n    0x00, 0x00, 0x00, 0x00]);\n\n/** Note lookup table. */\nconst IWAS_NOTE_LOOKUP: usize = memory.data<u16>([\n    16,   17,   18,   19,   20,   21,   23,   24,\n    25,   27,   29,   30,   32,   34,   36,   38,\n    41,   43,   46,   49,   51,   55,   58,   61,\n    65,   69,   73,   77,   82,   87,   92,   98,\n   103,  110,  116,  123,  130,  138,  146,  155,\n   164,  174,  185,  196,  207,  220,  233,  246,\n   261,  277,  293,  311,  329,  349,  369,  392,\n   415,  440,  466,  493,  523,  554,  587,  622,\n   659,  698,  739,  783,  830,  880,  932,  987,\n  1046, 1108, 1174, 1244, 1318, 1396, 1479, 1567,\n  1661, 1760, 1864, 1975, 2093, 2217, 2349, 2489,\n  2637, 2793, 2959, 3135, 3322, 3520, 3729, 3951\n]);\n\n/** Speed lookup table. */\nconst IWAS_SPEED_LOOKUP: usize = memory.data<u8>([\n    0, 2, 4, 6, 8, 10, 20, 30, 40, 60, 80\n]);\n\n/** Speed counter. */\nlet counter: u8 = 0;\n\n/** Note cursor. */\nlet cursor: u8 = 0;\n\n/**\n * Load `u16` value (big-endian).\n * \n * @param offset Address offset\n */\nfunction loadUint16BE(offset: usize): u16 {\n    /** High byte. */\n    const hi: u16 = u16(load<u8>(offset));\n\n    /** Low byte. */\n    const lo: u16 = u16(load<u8>(offset + 1));\n\n    return (hi * 0x100) + lo;\n}\n\n/**\n * Play music.\n */\nfunction play(): void {\n    // Countdown delay...\n    counter = counter > 0? counter - 1: 0;\n    \n    // Return if it's not ready to play yet...\n    if(counter > 0) {\n        return;\n    }\n\n    // When it reaches zero, it will iterate through each channel to play \n    // every note...\n    for(let ichannel: u8 = 0; ichannel < 4; ichannel += 1) {\n        /** Channel data offset. */\n        const offset: usize = data + 32 + (224 * ichannel);\n\n        /** Note value. */\n        const note: i8 = load<i8>(offset + 32 + (cursor % 192));\n\n        /** Check if channel is enabled. */\n        const isEnabled: bool = load<bool>(offset + 30);\n\n        // Ignore if is not enabled...\n        if(!isEnabled) {\n            return;\n        }\n\n        // Notes with a value of -128 represent a note break.\n        //\n        // Note breaks will mute a specific channel if it's still\n        // playing a tone.\n        if(note === -128) {\n            w4.tone(0, 0, 0, ichannel);\n            continue;\n        }\n\n        // Notes ranging from -96 and 96 are valid tones.\n        //\n        // Positive notes will use the main channel, while\n        // negative notes will use the shadow channel. \n        //\n        // Anything else, or 0, can be ignored.\n        else if(note !== 0 && note >= -96 && note <= 96) {\n            /** Instrument offset:\n             * - Main channel if positive.\n             * - Shadow channel if negative.\n             */\n            const instrument: usize = offset + (note > 0? 0: 9);\n\n            /**\n             * Note index for the note lookup table.\n             * \n             * If negative, it's value will be mirrored.\n             * For instance, `-1` will become `1`.\n             */\n            const inote: u8 = u8(Math.abs(note)) - 1;\n\n            // Get frequency from note lookup table...\n            const frq1: u32 = (load<u16>(IWAS_NOTE_LOOKUP + (inote * 2)));\n\n\n\n            // Get instrument data.\n            //\n            // A positive note index should point to the main channel, and\n            // a negative note index should point to the shadow channel.\n            //\n            // `frq2` is a big-endian value, so it must be converted.\n            //\n            // Values are converted to `u32` in order to better fit into the\n            // bitwise operations needed for the `tone` function to work.\n            const frq2: u32 = u32(loadUint16BE(instrument));\n            const atk: u32= u32(load<u8>(instrument + 2));\n            const dec: u32 = u32(load<u8>(instrument + 3));\n            const sus: u32 = u32(load<u8>(instrument + 4));\n            const rel: u32 = u32(load<u8>(instrument + 5));\n            const peak: u32 = u32(load<u8>(instrument + 6));\n            const vol: u32 = u32(load<u8>(instrument + 7));\n            const mode: u32 = u32(load<u8>(instrument + 8));\n            const pan: u32 = 0;\n\n            // Play tone:\n            w4.tone(\n                frq1 | (frq2 << 16),\n                (atk << 24) | (dec << 16) | sus | (rel << 8),\n                (peak << 8) | vol,\n                ichannel | (mode << 2) | (pan << 4)\n            );\n        }\n    }\n\n    /** Music length.\n     * \n     * To get the actual note count, the page number\n     * can be multiplied by 16.\n     */\n    const length: u8 = load<u8>(data + 6) * 16;\n\n    /** Speed index for the speed lookup table. */\n    const ispeed: u8 = load<u8>(data + 7);\n\n    /** Speed value. */\n    const speed: u8 = load<u8>(IWAS_SPEED_LOOKUP + ispeed);\n\n    // Advance counter and cursor...\n    counter = speed;\n    cursor = cursor < length? cursor + 1: 0;\n}\n\n/**\n * WASM-4 update event.\n */\nexport function update(): void {\n    play();\n    w4.text(`counter: ${counter}\\nCursor: ${cursor}`, 0, 0);\n}\n")),(0,r.kt)("p",null,"And with that, we have a way of making music for WASM-4 using nothing but a small sound tool!"),(0,r.kt)("h2",{id:"optional-challenges"},"Optional challenges"),(0,r.kt)("p",null,"Here's some optional challenges you can take in order to make this a little more efficient:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Parse and export it to your own music formats."),(0,r.kt)("li",{parentName:"ul"},"Use a compression/decompression algorithm to reduce size."),(0,r.kt)("li",{parentName:"ul"},"Make a longer music by chaining multiple files together."),(0,r.kt)("li",{parentName:"ul"},"Break a song into patterns and tracks to reduce size.")),(0,r.kt)("p",null,"If you're already familiar with a Digital Audio Workstation (DAW), you can also look for\na more advanced tool, like (w4on2)","[https://github.com/JerwuQu/w4on2]","."),(0,r.kt)("p",null,"Keep in mind, however, that no matter which tool you use, there might not be any driver\navailable for the language you want to use. So consider understanding the format first,\nthen learn how to implement your own driver if necessary (use a pre-existing driver as a reference)."))}d.isMDXComponent=!0}}]);